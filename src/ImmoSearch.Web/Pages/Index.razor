@page "/"
@using ImmoSearch.Domain.Extensions
@using ImmoSearch.Domain.Repositories

<div class="mb-3 d-flex gap-2 align-items-center flex-wrap">
    <button class="btn btn-outline-secondary" @onclick="ToggleFilters">@(_showFilters ? "Hide filters" : "Filters")</button>
    <button class="btn btn-primary" @onclick="ApplyFilters" disabled="@_loading">Apply</button>
    <button class="btn btn-outline-secondary" @onclick="ClearFilters" disabled="@_loading">Clear</button>
    <span class="text-muted">Page @_page / @(_totalPages == 0 ? 1 : _totalPages)</span>
</div>

@if (_showFilters)
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-12 col-md-3">
                    <label class="form-label">City</label>
                    <input class="form-control" @bind="_city" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">ZIP</label>
                    <input class="form-control" @bind="_zip" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Source</label>
                    <input class="form-control" @bind="_source" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Price from</label>
                    <input class="form-control" type="number" @bind="_minPrice" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Price to</label>
                    <input class="form-control" type="number" @bind="_maxPrice" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Size from</label>
                    <input class="form-control" type="number" @bind="_minSize" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Size to</label>
                    <input class="form-control" type="number" @bind="_maxSize" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Rooms from</label>
                    <input class="form-control" type="number" step="0.5" @bind="_minRooms" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">Rooms to</label>
                    <input class="form-control" type="number" step="0.5" @bind="_maxRooms" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">From date</label>
                    <input class="form-control" type="date" @bind="_fromDate" />
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label">To date</label>
                    <input class="form-control" type="date" @bind="_toDate" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">Search</label>
                    <input class="form-control" @bind="_query" />
                </div>
            </div>
        </div>
    </div>
}

@if (_loading)
{
    <p>Loading...</p>
}
else if (_error)
{
    <p class="text-danger">Failed to load listings.</p>
}
else if (_result?.Items?.Count == 0)
{
    <p>No listings found.</p>
}
else if (_result is not null)
{
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Listings</h5>
                <span class="badge bg-light text-dark">@_result.TotalCount total</span>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle listings-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 110px;"></th>
                            <th>@SortHeader("title", "Title")</th>
                            <th>@SortHeader("city", "City")</th>
                            <th>@SortHeader("price", "Price")</th>
                            <th>@SortHeader("size", "Size")</th>
                            <th>@SortHeader("rooms", "Rooms")</th>
                            <th>@SortHeader("firstseen", "First seen")</th>
                            <th>@SortHeader("lastseen", "Last seen")</th>
                            <th>Source</th>
                            <th style="width: 60px;">Link</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in _result.Items)
                    {
                        <tr>
                            <td>
                                @if (item.ThumbnailUrl.HasText)
                                {
                                    <a href="@item.Url" target="_blank" title="Open listing">
                                        <img src="@item.ThumbnailUrl" alt="thumb" class="img-thumbnail" style="max-width: 100px; max-height: 75px; object-fit: cover;" />
                                    </a>
                                }
                            </td>
                            <td>@item.Title</td>
                            <td>@item.City</td>
                            <td>@(item.Price.HasValue ? item.Price.Value.ToString("C0") : "–")</td>
                            <td>@(item.Size.HasValue ? $"{item.Size:F0} m²" : "–")</td>
                            <td>@(item.Rooms.HasValue ? $"{item.Rooms:F1}" : "–")</td>
                            <td>@item.FirstSeenAt.ToString("yyyy-MM-dd")</td>
                            <td>@item.LastSeenAt.ToString("yyyy-MM-dd")</td>
                            <td>@item.Source</td>
                            <td><a href="@item.Url" target="_blank" title="Open listing">↗</a></td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-secondary" @onclick="Prev" disabled="@(_page <= 1)">Prev</button>
                <div class="text-muted">Page @_page / @_totalPages</div>
                <button class="btn btn-outline-secondary" @onclick="Next" disabled="@(_page >= _totalPages)">Next</button>
            </div>
        </div>
    </div>
}

@code {
    int _pageSize = 20;
    int _page = 1;
    int _totalPages = 1;
    bool _loading;
    bool _error;
    PagedResult<Listing>? _result;
    ScrapeSettings? _settings;
    string? _sortBy = "scrapedat";
    bool _sortDesc = true;
    bool _showFilters;

    string? _city;
    string? _zip;
    string? _source;
    decimal? _minPrice;
    decimal? _maxPrice;
    decimal? _minSize;
    decimal? _maxSize;
    decimal? _minRooms;
    decimal? _maxRooms;
    DateOnly? _fromDate;
    DateOnly? _toDate;
    string? _query;

    [Inject]
    public ListingApiClient ApiClient { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await LoadPage(_page);
    }

    async Task LoadPage(int page)
    {
        _loading = true;
        _error = false;
        StateHasChanged();

        try
        {
            DateTimeOffset? fromDate = _fromDate.HasValue
                ? new DateTimeOffset(_fromDate.Value.ToDateTime(TimeOnly.MinValue, DateTimeKind.Utc))
                : null;
            DateTimeOffset? toDate = _toDate.HasValue
                ? new DateTimeOffset(_toDate.Value.ToDateTime(TimeOnly.MaxValue, DateTimeKind.Utc))
                : null;

            var filter = new ListingFilter(
                City: _city,
                Zip: _zip,
                Source: _source,
                MinPrice: _minPrice,
                MaxPrice: _maxPrice,
                MinSize: _minSize,
                MaxSize: _maxSize,
                MinRooms: _minRooms,
                MaxRooms: _maxRooms,
                FromDate: fromDate,
                ToDate: toDate,
                Query: _query);

            var sort = new ListingSort(_sortBy, _sortDesc);

            _result = await ApiClient.GetListingsAsync(
                page,
                _pageSize,
                filter,
                sort);
            if (_result is null)
            {
                _error = true;
                return;
            }

            _page = page;
            _totalPages = (int)Math.Ceiling((double)_result.TotalCount / _result.PageSize);
            if (_totalPages == 0) _totalPages = 1;
        }
        catch
        {
            _error = true;
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    async Task LoadSettings()
    {
        try
        {
            _settings = await ApiClient.GetSettingsAsync();
            if (_settings is not null && _settings.PageSize > 0)
                _pageSize = _settings.PageSize;
        }
        catch
        {
            _error = true;
        }
    }

    Task Refresh() => LoadPage(_page);

    Task ApplyFilters()
    {
        _page = 1;
        return LoadPage(_page);
    }

    Task ClearFilters()
    {
        _city = null;
        _zip = null;
        _source = null;
        _minPrice = null;
        _maxPrice = null;
        _minSize = null;
        _maxSize = null;
        _minRooms = null;
        _maxRooms = null;
        _fromDate = null;
        _toDate = null;
        _query = null;
        _page = 1;
        return LoadPage(_page);
    }

    Task SortBy(string key)
    {
        if (string.Equals(_sortBy, key, StringComparison.OrdinalIgnoreCase))
            _sortDesc = !_sortDesc;
        else
        {
            _sortBy = key;
            _sortDesc = key.Equals("scrapedat", StringComparison.OrdinalIgnoreCase);
        }

        return LoadPage(1);
    }

    RenderFragment SortHeader(string key, string label) => builder =>
    {
        var isActive = string.Equals(_sortBy, key, StringComparison.OrdinalIgnoreCase);
        var sortSymbol = isActive ? (_sortDesc ? "▼" : "▲") : string.Empty;

        builder.OpenElement(0, "button");
        builder.AddAttribute(1, "type", "button");
        builder.AddAttribute(2, "class", "btn btn-link p-0 text-start sort-header");
        builder.AddAttribute(3, "onclick", EventCallback.Factory.Create(this, () => SortBy(key)));
        builder.AddContent(4, label);
        if (!string.IsNullOrEmpty(sortSymbol))
        {
            builder.AddContent(5, " ");
            builder.AddContent(6, sortSymbol);
        }
        builder.CloseElement();
    };

    Task Prev()
    {
        if (_page > 1) return LoadPage(_page - 1);
        return Task.CompletedTask;
    }

    Task Next()
    {
        if (_page < _totalPages) return LoadPage(_page + 1);
        return Task.CompletedTask;
    }

    void ToggleFilters() => _showFilters = !_showFilters;
}
